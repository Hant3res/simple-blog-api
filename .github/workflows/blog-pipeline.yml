name: ðŸš€ Blog API Pipeline

on:
  push:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/SimpleBlog.API'
  TEST_PATH: 'tests/SimpleBlog.API.Tests'

jobs:
  # Ð”Ð¶Ð¾Ð±Ð° 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
  build:
    name: ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ’¬ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v4

    - name: ðŸ’¬ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      run: |
        echo "=== Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™ ==="
        dotnet restore
        echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

    - name: ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      run: |
        echo "=== Ð¡Ð‘ÐžÐ ÐšÐ ÐžÐ¡ÐÐžÐ’ÐÐžÐ“Ðž ÐŸÐ ÐžÐ•ÐšÐ¢Ð ==="
        dotnet build ${{ env.PROJECT_PATH }} --configuration Release --verbosity minimal
        echo "âœ… ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð±Ñ€Ð°Ð½"

    - name: ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      run: |
        echo "=== Ð¡Ð‘ÐžÐ ÐšÐ Ð¢Ð•Ð¡Ð¢ÐžÐ’ÐžÐ“Ðž ÐŸÐ ÐžÐ•ÐšÐ¢Ð ==="
        dotnet build ${{ env.TEST_PATH }} --configuration Debug --verbosity minimal
        echo "âœ… Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð±Ñ€Ð°Ð½"

    - name: ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ env.PROJECT_PATH }}/bin/
          ${{ env.TEST_PATH }}/bin/
        retention-days: 7

  # Ð”Ð¶Ð¾Ð±Ð° 2: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
  test:
    name: ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ’¬ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v4

    - name: ðŸ’¬ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹
      run: |
        echo "=== Ð—ÐÐŸÐ£Ð¡Ðš Ð¢Ð•Ð¡Ð¢ÐžÐ’ ==="
        echo "ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: 4"
        echo "Ð˜Ð· Ð½Ð¸Ñ…:"
        echo "  - 3 unit Ñ‚ÐµÑÑ‚Ð°"
        echo "  - 1 Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚"
        echo ""
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
        cd tests/SimpleBlog.API.Tests
        dotnet test --verbosity normal
        
        echo ""
        echo "âœ… Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"

    - name: ðŸ“Š Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð²
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ${{ env.TEST_PATH }}/TestResults/
        retention-days: 30

  # Ð”Ð¶Ð¾Ð±Ð° 3: Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°
  docker-build:
    name: ðŸ³ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker
    needs: [build, test]
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ’¬ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v4

    - name: ðŸ³ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Docker Ð¾Ð±Ñ€Ð°Ð·
      run: |
        echo "=== Ð¡Ð‘ÐžÐ ÐšÐ DOCKER ÐžÐ‘Ð ÐÐ—Ð ==="
        docker build -t simple-blog-api:latest .
        echo "âœ… Docker Ð¾Ð±Ñ€Ð°Ð· ÑÐ¾Ð±Ñ€Ð°Ð½"
        docker images | grep simple-blog-api

  # Ð”Ð¶Ð¾Ð±Ð° 4: ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
  publish:
    name: ðŸ“¦ ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ
    needs: [build, test, docker-build]
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ’¬ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð´
      uses: actions/checkout@v4

    - name: ðŸ’¬ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
      run: |
        echo "=== ÐŸÐ£Ð‘Ð›Ð˜ÐšÐÐ¦Ð˜Ð¯ ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯ ==="
        dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ./publish
        echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð¾"
        
        echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ publish:"
        ls -la ./publish/

    - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
      run: |
        echo "=== Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ðž Ð¡Ð‘ÐžÐ ÐšÐ• ==="
        cat > ./publish/build-info.txt << EOL
        Build Information
        =================
        Application: Simple Blog API
        Version: 1.0.0
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref }}
        Built: $(date)
        Author: ${{ github.actor }}
        .NET Version: ${{ env.DOTNET_VERSION }}
        EOL
        
        echo "âœ… Ð¤Ð°Ð¹Ð» build-info.txt ÑÐ¾Ð·Ð´Ð°Ð½"

    - name: ðŸ“¦ ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
      run: |
        echo "=== ÐÐ Ð¥Ð˜Ð’ÐÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ Ð Ð•Ð›Ð˜Ð—Ð ==="
        zip -r simple-blog-api-release.zip ./publish/
        echo "âœ… ÐÑ€Ñ…Ð¸Ð² ÑÐ¾Ð·Ð´Ð°Ð½"
        ls -lh simple-blog-api-release.zip

    - name: ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð·Ð½Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: simple-blog-api-release.zip
        retention-days: 30

  # Ð”Ð¶Ð¾Ð±Ð° 5: Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  report:
    name: ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
    needs: [build, test, docker-build, publish]
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“ˆ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
      run: |
        echo "========================================"
        echo "ðŸŽ‰ ÐŸÐžÐ›ÐÐ«Ð™ ÐžÐ¢Ð§Ð•Ð¢ Ðž Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð˜ ÐŸÐÐ™ÐŸÐ›ÐÐ™ÐÐ"
        echo "========================================"
        echo ""
        echo "ðŸ“‹ Ð’Ð¡Ð• Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐÐ«Ð• Ð­Ð¢ÐÐŸÐ«:"
        echo "âœ… 1. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (build)"
        echo "   - Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
        echo "   - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
        echo "   - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
        echo ""
        echo "âœ… 2. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (test)"
        echo "   - Ð—Ð°Ð¿ÑƒÑÐº unit Ñ‚ÐµÑÑ‚Ð¾Ð²: 3 Ñ‚ÐµÑÑ‚Ð°"
        echo "   - Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²: 1 Ñ‚ÐµÑÑ‚"
        echo "   - Ð’ÑÐµÐ³Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: 4"
        echo ""
        echo "âœ… 3. Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð° (docker-build)"
        echo "   - Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð° simple-blog-api:latest"
        echo ""
        echo "âœ… 4. ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (publish)"
        echo "   - ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
        echo "   - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð° Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°"
        echo ""
        echo "ðŸ“¦ Ð¡ÐžÐ—Ð”ÐÐÐÐ«Ð• ÐÐ Ð¢Ð•Ð¤ÐÐšÐ¢Ð«:"
        echo "ðŸ“ build-artifacts - Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸"
        echo "ðŸ“ test-results - Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
        echo "ðŸ“ release-package - Ñ€ÐµÐ»Ð¸Ð·Ð½Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚"
        echo ""
        echo "ðŸ”§ Ð¢Ð•Ð¥ÐÐ˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯:"
        echo "   ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: Simple Blog API"
        echo "   .NET Version: ${{ env.DOTNET_VERSION }}"
        echo "   Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}"
        echo "   ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}"
        echo "   ÐÐ²Ñ‚Ð¾Ñ€: ${{ github.actor }}"
        echo "   Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: ${{ github.event.head_commit.timestamp }}"
        echo "   Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ: $(date)"
        echo ""
        echo "ðŸ Ð˜Ð¢ÐžÐ“ÐžÐ’Ð«Ð™ Ð¡Ð¢ÐÐ¢Ð£Ð¡: Ð£Ð¡ÐŸÐ•Ð¨ÐÐž"
        echo "Ð’ÑÐµ 4 ÑÑ‚Ð°Ð¿Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº!"
        echo "========================================"
    
    - name: ðŸŽ¯ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
      if: always()
      run: |
        echo ""
        echo "ðŸŒŸ Ð§Ð¢Ðž Ð”ÐÐ›Ð¬Ð¨Ð•?"
        echo "1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸Ð· Ñ€Ð°Ð·Ð´ÐµÐ»Ð° 'Artifacts'"
        echo "2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ release-package.zip Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ"
        echo "3. Docker Ð¾Ð±Ñ€Ð°Ð· Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ"
        echo "4. Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
